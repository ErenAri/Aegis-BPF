{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/aegisbpf/aegisbpf/blob/main/config/event-schema.json",
  "title": "AegisBPF Event Schema",
  "description": "JSON Schema for AegisBPF security events",
  "type": "object",
  "oneOf": [
    { "$ref": "#/$defs/ExecEvent" },
    { "$ref": "#/$defs/BlockEvent" },
    { "$ref": "#/$defs/NetBlockEvent" },
    { "$ref": "#/$defs/StateChangeEvent" }
  ],
  "$defs": {
    "ExecEvent": {
      "type": "object",
      "description": "Execution event - emitted when a process execution is observed",
      "required": ["type", "pid", "ppid", "start_time", "cgid", "cgroup_path", "comm"],
      "properties": {
        "type": {
          "type": "string",
          "const": "exec",
          "description": "Event type identifier"
        },
        "pid": {
          "type": "integer",
          "minimum": 0,
          "description": "Process ID of the executed process"
        },
        "ppid": {
          "type": "integer",
          "minimum": 0,
          "description": "Parent process ID"
        },
        "start_time": {
          "type": "integer",
          "minimum": 0,
          "description": "Process start time in kernel ticks or nanoseconds"
        },
        "exec_id": {
          "type": "string",
          "description": "Stable execution identifier (pid:start_time)"
        },
        "trace_id": {
          "type": "string",
          "description": "Correlation identifier for cross-signal tracing (matches exec_id)"
        },
        "cgid": {
          "type": "integer",
          "minimum": 0,
          "description": "Cgroup ID (inode number of cgroup directory)"
        },
        "cgroup_path": {
          "type": "string",
          "description": "Full path of the cgroup"
        },
        "comm": {
          "type": "string",
          "maxLength": 16,
          "description": "Command name (truncated to 16 characters)"
        }
      },
      "additionalProperties": false
    },
    "BlockEvent": {
      "type": "object",
      "description": "Block or audit event emitted on denied file open attempts",
      "required": [
        "type",
        "pid",
        "ppid",
        "start_time",
        "parent_start_time",
        "cgid",
        "cgroup_path",
        "ino",
        "dev",
        "action",
        "comm"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "block",
          "description": "Event type identifier"
        },
        "pid": {
          "type": "integer",
          "minimum": 0,
          "description": "Process ID that attempted the access"
        },
        "ppid": {
          "type": "integer",
          "minimum": 0,
          "description": "Parent process ID"
        },
        "start_time": {
          "type": "integer",
          "minimum": 0,
          "description": "Process start time"
        },
        "exec_id": {
          "type": "string",
          "description": "Stable execution identifier (pid:start_time)"
        },
        "trace_id": {
          "type": "string",
          "description": "Correlation identifier for cross-signal tracing (matches exec_id)"
        },
        "parent_start_time": {
          "type": "integer",
          "minimum": 0,
          "description": "Parent process start time"
        },
        "parent_exec_id": {
          "type": "string",
          "description": "Stable parent execution identifier (ppid:parent_start_time)"
        },
        "parent_trace_id": {
          "type": "string",
          "description": "Parent correlation identifier (matches parent_exec_id)"
        },
        "cgid": {
          "type": "integer",
          "minimum": 0,
          "description": "Cgroup ID (inode number of cgroup directory)"
        },
        "cgroup_path": {
          "type": "string",
          "description": "Full path of the cgroup"
        },
        "ino": {
          "type": "integer",
          "minimum": 0,
          "description": "Inode number of the file"
        },
        "dev": {
          "type": "integer",
          "minimum": 0,
          "description": "Device number of the file"
        },
        "path": {
          "type": "string",
          "description": "Path of the file when available"
        },
        "resolved_path": {
          "type": "string",
          "description": "Resolved canonical path (if different from path)"
        },
        "action": {
          "type": "string",
          "enum": ["AUDIT", "INT", "TERM", "KILL", "BLOCK"],
          "description": "Action taken (AUDIT in audit mode, enforce action in enforce mode)"
        },
        "comm": {
          "type": "string",
          "maxLength": 16,
          "description": "Command name (truncated to 16 characters)"
        }
      },
      "additionalProperties": false
    },
    "NetBlockEvent": {
      "type": "object",
      "description": "Network block or audit event emitted on denied connect/bind attempts",
      "required": [
        "type",
        "pid",
        "ppid",
        "start_time",
        "parent_start_time",
        "cgid",
        "cgroup_path",
        "family",
        "protocol",
        "direction",
        "action",
        "rule_type",
        "comm"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["net_connect_block", "net_bind_block"],
          "description": "Event type identifier"
        },
        "pid": {
          "type": "integer",
          "minimum": 0,
          "description": "Process ID that attempted the network operation"
        },
        "ppid": {
          "type": "integer",
          "minimum": 0,
          "description": "Parent process ID"
        },
        "start_time": {
          "type": "integer",
          "minimum": 0,
          "description": "Process start time"
        },
        "exec_id": {
          "type": "string",
          "description": "Stable execution identifier (pid:start_time)"
        },
        "trace_id": {
          "type": "string",
          "description": "Correlation identifier for cross-signal tracing"
        },
        "parent_start_time": {
          "type": "integer",
          "minimum": 0,
          "description": "Parent process start time"
        },
        "parent_exec_id": {
          "type": "string",
          "description": "Stable parent execution identifier (ppid:parent_start_time)"
        },
        "cgid": {
          "type": "integer",
          "minimum": 0,
          "description": "Cgroup ID (inode number of cgroup directory)"
        },
        "cgroup_path": {
          "type": "string",
          "description": "Full path of the cgroup"
        },
        "family": {
          "type": "integer",
          "enum": [2, 10],
          "description": "Address family (2=AF_INET, 10=AF_INET6)"
        },
        "protocol": {
          "type": "integer",
          "enum": [6, 17],
          "description": "IP protocol (6=TCP, 17=UDP)"
        },
        "direction": {
          "type": "string",
          "enum": ["egress", "bind"],
          "description": "Network direction (egress for connect, bind for listen)"
        },
        "remote_ip": {
          "type": "string",
          "description": "Remote IP address (for connect events)"
        },
        "remote_port": {
          "type": "integer",
          "minimum": 0,
          "maximum": 65535,
          "description": "Remote port (for connect events)"
        },
        "local_port": {
          "type": "integer",
          "minimum": 0,
          "maximum": 65535,
          "description": "Local port (for bind events)"
        },
        "rule_type": {
          "type": "string",
          "enum": ["ip", "cidr", "port"],
          "description": "Type of deny rule that matched"
        },
        "action": {
          "type": "string",
          "enum": ["AUDIT", "INT", "TERM", "KILL", "BLOCK"],
          "description": "Action taken"
        },
        "comm": {
          "type": "string",
          "maxLength": 16,
          "description": "Command name (truncated to 16 characters)"
        }
      },
      "additionalProperties": false
    },
    "StateChangeEvent": {
      "type": "object",
      "description": "Runtime state transition event emitted when enforcement posture changes",
      "required": [
        "type",
        "event_version",
        "state",
        "reason_code",
        "strict_mode",
        "transition_id",
        "degradation_count"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "state_change",
          "description": "Event type identifier"
        },
        "event_version": {
          "type": "integer",
          "const": 1,
          "description": "Version of the state-change event schema"
        },
        "state": {
          "type": "string",
          "enum": ["ENFORCE", "AUDIT_FALLBACK", "DEGRADED"],
          "description": "Current runtime posture"
        },
        "reason_code": {
          "type": "string",
          "minLength": 1,
          "description": "Machine-readable reason for the transition"
        },
        "detail": {
          "type": "string",
          "description": "Optional human-readable transition detail"
        },
        "strict_mode": {
          "type": "boolean",
          "description": "Whether strict degrade mode is enabled"
        },
        "transition_id": {
          "type": "integer",
          "minimum": 1,
          "description": "Monotonic transition sequence number for this process"
        },
        "degradation_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of transitions into fallback/degraded states"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "type": "exec",
      "pid": 12345,
      "ppid": 1000,
      "start_time": 123456789,
      "exec_id": "12345:123456789",
      "trace_id": "12345:123456789",
      "cgid": 5678,
      "cgroup_path": "/sys/fs/cgroup/user.slice/user-1000.slice",
      "comm": "bash"
    },
    {
      "type": "block",
      "pid": 12346,
      "ppid": 12345,
      "start_time": 223456789,
      "exec_id": "12346:223456789",
      "trace_id": "12346:223456789",
      "parent_start_time": 123456789,
      "parent_exec_id": "12345:123456789",
      "parent_trace_id": "12345:123456789",
      "cgid": 5678,
      "cgroup_path": "/sys/fs/cgroup/user.slice/user-1000.slice",
      "ino": 123456,
      "dev": 259,
      "path": "/etc/shadow",
      "resolved_path": "/etc/shadow",
      "action": "KILL",
      "comm": "cat"
    },
    {
      "type": "net_connect_block",
      "pid": 12347,
      "ppid": 12345,
      "start_time": 323456789,
      "exec_id": "12347:323456789",
      "trace_id": "12347:323456789",
      "parent_start_time": 123456789,
      "parent_exec_id": "12345:123456789",
      "cgid": 5678,
      "cgroup_path": "/sys/fs/cgroup/user.slice/user-1000.slice",
      "family": 2,
      "protocol": 6,
      "direction": "egress",
      "remote_ip": "10.0.0.1",
      "remote_port": 443,
      "rule_type": "ip",
      "action": "TERM",
      "comm": "curl"
    },
    {
      "type": "state_change",
      "event_version": 1,
      "state": "AUDIT_FALLBACK",
      "reason_code": "CAPABILITY_AUDIT_ONLY",
      "detail": "kernel lacks required enforce hooks",
      "strict_mode": false,
      "transition_id": 2,
      "degradation_count": 1
    }
  ]
}
