name: Branch Protection Audit

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"

permissions:
  contents: read
  issues: write

jobs:
  audit:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Audit branch protection required checks
        id: audit_checks
        continue-on-error: true
        env:
          BRANCH_PROTECTION_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          if [[ -z "${BRANCH_PROTECTION_TOKEN}" ]]; then
            echo "BRANCH_PROTECTION_TOKEN is not configured; skipping audit."
            echo "Set an admin-capable token in repository secrets to enable this check."
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          export GH_TOKEN="${BRANCH_PROTECTION_TOKEN}"
          set +e
          REPO="${REPO}" MAIN_BRANCH=main \
            REQUIRED_MAIN_FILE=config/required_checks.txt \
            REQUIRED_RELEASE_FILE=config/required_checks_release.txt \
            scripts/audit_branch_protection_matrix.sh | tee branch-protection-audit.log
          rc=${PIPESTATUS[0]}
          set -e
          if [[ "$rc" -ne 0 ]]; then
            echo "failed=true" >> "$GITHUB_OUTPUT"
            exit "$rc"
          fi
          echo "failed=false" >> "$GITHUB_OUTPUT"
          echo "skipped=false" >> "$GITHUB_OUTPUT"

      - name: Upload audit log
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: branch-protection-audit
          path: branch-protection-audit.log

      - name: Open or update drift issue
        if: steps.audit_checks.outputs.failed == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const title = 'Branch protection drift detected';
            const body = [
              'Automated branch protection audit failed.',
              '',
              'Review workflow artifact `branch-protection-audit` for missing required checks.',
              'Update branch protection or required-check source files to re-align.',
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,triage',
              per_page: 100,
            });

            const existing = issues.find((i) => i.title === title);
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
              core.info(`Updated issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                labels: ['security', 'triage'],
                body,
              });
              core.info(`Created issue #${created.data.number}`);
            }

      - name: Fail workflow on drift
        if: steps.audit_checks.outputs.failed == 'true'
        run: exit 1
